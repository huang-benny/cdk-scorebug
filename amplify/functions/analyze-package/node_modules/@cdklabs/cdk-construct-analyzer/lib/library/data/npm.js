"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NpmCollector = void 0;
class NpmCollector {
    async fetchPackage(packageName) {
        const packageRes = await fetch(`https://registry.npmjs.org/${packageName}`);
        if (!packageRes.ok) {
            throw new Error(`NPM registry returned ${packageRes.status}: ${packageRes.statusText}`);
        }
        // Extract only the fields we need from the API response
        const response = await packageRes.json();
        const latestVersion = response['dist-tags']?.latest;
        const versionData = response.versions?.[latestVersion];
        const hasProvenance = Boolean(versionData?.dist?.attestations?.url);
        this.packageData = {
            name: response.name,
            version: latestVersion,
            repository: response.repository,
            isDeprecated: Boolean(versionData?.deprecated),
            hasProvenance,
            packageJson: versionData,
            maintainers: response.maintainers,
        };
    }
    getPackageData() {
        if (!this.packageData) {
            throw new Error('Must call fetchPackage() first');
        }
        return this.packageData;
    }
    async fetchDownloadData() {
        if (!this.packageData) {
            throw new Error('Must call fetchPackage() first');
        }
        const response = await fetch(`https://api.npmjs.org/downloads/point/last-week/${this.packageData.name}`);
        if (!response.ok) {
            throw new Error(`NPM downloads API returned ${response.status}: ${response.statusText}`);
        }
        return await response.json();
    }
    async fetchAuthorPackageCount() {
        // Get the best (highest package count) maintainer
        const maintainers = this.packageData?.maintainers;
        if (!maintainers || maintainers.length === 0) {
            return undefined;
        }
        try {
            const counts = await Promise.all(maintainers.map(async (maintainer) => {
                if (!maintainer?.name) {
                    return 0;
                }
                try {
                    const response = await fetch(`https://registry.npmjs.org/-/v1/search?text=maintainer:${encodeURIComponent(maintainer.name)}&size=1`);
                    if (!response.ok) {
                        return undefined;
                    }
                    const data = await response.json();
                    return data.total ?? 0;
                }
                catch {
                    return 0;
                }
            }));
            const maxCount = Math.max(...counts);
            // Return undefined if all requests failed
            return maxCount > 0 ? maxCount : undefined;
        }
        catch {
            return undefined;
        }
    }
}
exports.NpmCollector = NpmCollector;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnBtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYnJhcnkvZGF0YS9ucG0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBa0JBLE1BQWEsWUFBWTtJQUd2QixLQUFLLENBQUMsWUFBWSxDQUFDLFdBQW1CO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLE1BQU0sS0FBSyxDQUFDLDhCQUE4QixXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsVUFBVSxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUMxRixDQUFDO1FBRUQsd0RBQXdEO1FBQ3hELE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDLElBQUksRUFBUyxDQUFDO1FBQ2hELE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLENBQUM7UUFFcEQsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVwRSxJQUFJLENBQUMsV0FBVyxHQUFHO1lBQ2pCLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtZQUNuQixPQUFPLEVBQUUsYUFBYTtZQUN0QixVQUFVLEVBQUUsUUFBUSxDQUFDLFVBQVU7WUFDL0IsWUFBWSxFQUFFLE9BQU8sQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDO1lBQzlDLGFBQWE7WUFDYixXQUFXLEVBQUUsV0FBVztZQUN4QixXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVc7U0FDbEMsQ0FBQztJQUNKLENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQjtRQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBRUQsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsbURBQW1ELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUN6RyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLFFBQVEsQ0FBQyxNQUFNLEtBQUssUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDM0YsQ0FBQztRQUVELE9BQU8sTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFxQixDQUFDO0lBQ2xELENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCO1FBQzNCLGtEQUFrRDtRQUNsRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQztRQUNsRCxJQUFJLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDN0MsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDOUIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUU7Z0JBQ25DLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUM7b0JBQ3RCLE9BQU8sQ0FBQyxDQUFDO2dCQUNYLENBQUM7Z0JBQ0QsSUFBSSxDQUFDO29CQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLDBEQUEwRCxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUNySSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxDQUFDO3dCQUNqQixPQUFPLFNBQVMsQ0FBQztvQkFDbkIsQ0FBQztvQkFDRCxNQUFNLElBQUksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQVMsQ0FBQztvQkFFMUMsT0FBTyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztnQkFDekIsQ0FBQztnQkFBQyxNQUFNLENBQUM7b0JBQ1AsT0FBTyxDQUFDLENBQUM7Z0JBQ1gsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUNILENBQUM7WUFDRixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFDckMsMENBQTBDO1lBQzFDLE9BQU8sUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDN0MsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFqRkQsb0NBaUZDIiwic291cmNlc0NvbnRlbnQiOlsiLy9UT0RPOiBBZGQgbW9yZSBmaWVsZHMgYXMgbW9yZSBzaWduYWxzIGFyZSBhZGRlZFxuZXhwb3J0IGludGVyZmFjZSBOcG1QYWNrYWdlRGF0YSB7XG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgdmVyc2lvbjogc3RyaW5nO1xuICByZWFkb25seSByZXBvc2l0b3J5OiB7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIHVybDogc3RyaW5nO1xuICB9O1xuICByZWFkb25seSBpc0RlcHJlY2F0ZWQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGhhc1Byb3ZlbmFuY2U/OiBib29sZWFuO1xuICByZWFkb25seSBwYWNrYWdlSnNvbj86IGFueTtcbiAgcmVhZG9ubHkgbWFpbnRhaW5lcnM/OiBBcnJheTx7IG5hbWU6IHN0cmluZyB9Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOcG1Eb3dubG9hZERhdGEge1xuICByZWFkb25seSBkb3dubG9hZHM6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIE5wbUNvbGxlY3RvciB7XG4gIHByaXZhdGUgcGFja2FnZURhdGE/OiBOcG1QYWNrYWdlRGF0YTtcblxuICBhc3luYyBmZXRjaFBhY2thZ2UocGFja2FnZU5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBhY2thZ2VSZXMgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9yZWdpc3RyeS5ucG1qcy5vcmcvJHtwYWNrYWdlTmFtZX1gKTtcblxuICAgIGlmICghcGFja2FnZVJlcy5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOUE0gcmVnaXN0cnkgcmV0dXJuZWQgJHtwYWNrYWdlUmVzLnN0YXR1c306ICR7cGFja2FnZVJlcy5zdGF0dXNUZXh0fWApO1xuICAgIH1cblxuICAgIC8vIEV4dHJhY3Qgb25seSB0aGUgZmllbGRzIHdlIG5lZWQgZnJvbSB0aGUgQVBJIHJlc3BvbnNlXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBwYWNrYWdlUmVzLmpzb24oKSBhcyBhbnk7XG4gICAgY29uc3QgbGF0ZXN0VmVyc2lvbiA9IHJlc3BvbnNlWydkaXN0LXRhZ3MnXT8ubGF0ZXN0O1xuXG4gICAgY29uc3QgdmVyc2lvbkRhdGEgPSByZXNwb25zZS52ZXJzaW9ucz8uW2xhdGVzdFZlcnNpb25dO1xuICAgIGNvbnN0IGhhc1Byb3ZlbmFuY2UgPSBCb29sZWFuKHZlcnNpb25EYXRhPy5kaXN0Py5hdHRlc3RhdGlvbnM/LnVybCk7XG5cbiAgICB0aGlzLnBhY2thZ2VEYXRhID0ge1xuICAgICAgbmFtZTogcmVzcG9uc2UubmFtZSxcbiAgICAgIHZlcnNpb246IGxhdGVzdFZlcnNpb24sXG4gICAgICByZXBvc2l0b3J5OiByZXNwb25zZS5yZXBvc2l0b3J5LFxuICAgICAgaXNEZXByZWNhdGVkOiBCb29sZWFuKHZlcnNpb25EYXRhPy5kZXByZWNhdGVkKSxcbiAgICAgIGhhc1Byb3ZlbmFuY2UsXG4gICAgICBwYWNrYWdlSnNvbjogdmVyc2lvbkRhdGEsXG4gICAgICBtYWludGFpbmVyczogcmVzcG9uc2UubWFpbnRhaW5lcnMsXG4gICAgfTtcbiAgfVxuXG4gIGdldFBhY2thZ2VEYXRhKCk6IE5wbVBhY2thZ2VEYXRhIHtcbiAgICBpZiAoIXRoaXMucGFja2FnZURhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTXVzdCBjYWxsIGZldGNoUGFja2FnZSgpIGZpcnN0Jyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBhY2thZ2VEYXRhO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hEb3dubG9hZERhdGEoKTogUHJvbWlzZTxOcG1Eb3dubG9hZERhdGE+IHtcbiAgICBpZiAoIXRoaXMucGFja2FnZURhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTXVzdCBjYWxsIGZldGNoUGFja2FnZSgpIGZpcnN0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9hcGkubnBtanMub3JnL2Rvd25sb2Fkcy9wb2ludC9sYXN0LXdlZWsvJHt0aGlzLnBhY2thZ2VEYXRhLm5hbWV9YCk7XG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOUE0gZG93bmxvYWRzIEFQSSByZXR1cm5lZCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIE5wbURvd25sb2FkRGF0YTtcbiAgfVxuXG4gIGFzeW5jIGZldGNoQXV0aG9yUGFja2FnZUNvdW50KCk6IFByb21pc2U8bnVtYmVyIHwgdW5kZWZpbmVkPiB7XG4gICAgLy8gR2V0IHRoZSBiZXN0IChoaWdoZXN0IHBhY2thZ2UgY291bnQpIG1haW50YWluZXJcbiAgICBjb25zdCBtYWludGFpbmVycyA9IHRoaXMucGFja2FnZURhdGE/Lm1haW50YWluZXJzO1xuICAgIGlmICghbWFpbnRhaW5lcnMgfHwgbWFpbnRhaW5lcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb3VudHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgbWFpbnRhaW5lcnMubWFwKGFzeW5jIChtYWludGFpbmVyKSA9PiB7XG4gICAgICAgICAgaWYgKCFtYWludGFpbmVyPy5uYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vcmVnaXN0cnkubnBtanMub3JnLy0vdjEvc2VhcmNoP3RleHQ9bWFpbnRhaW5lcjoke2VuY29kZVVSSUNvbXBvbmVudChtYWludGFpbmVyLm5hbWUpfSZzaXplPTFgKTtcbiAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCkgYXMgYW55O1xuXG4gICAgICAgICAgICByZXR1cm4gZGF0YS50b3RhbCA/PyAwO1xuICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgICBjb25zdCBtYXhDb3VudCA9IE1hdGgubWF4KC4uLmNvdW50cyk7XG4gICAgICAvLyBSZXR1cm4gdW5kZWZpbmVkIGlmIGFsbCByZXF1ZXN0cyBmYWlsZWRcbiAgICAgIHJldHVybiBtYXhDb3VudCA+IDAgPyBtYXhDb3VudCA6IHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG59Il19