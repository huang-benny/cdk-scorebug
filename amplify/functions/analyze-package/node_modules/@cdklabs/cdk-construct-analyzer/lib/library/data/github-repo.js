"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GitHubRepo = void 0;
class GitHubRepo {
    constructor(owner, repo) {
        this.owner = owner;
        this.repo = repo;
        this.graphqlUrl = 'https://api.github.com/graphql';
    }
    async metadata() {
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        const sinceDate = oneYearAgo.toISOString();
        const contentsQuery = `
      query GetRepositoryData($owner: String!, $name: String!, $since: GitTimestamp!) {
        repository(owner: $owner, name: $name) {
          stargazerCount
          
          # Root directory contents with nested directory contents (4 levels deep)
          rootContents: object(expression: "HEAD:") {
            ... on Tree {
              entries {
                name
                type
                object {
                  ... on Tree {
                    entries {
                      name
                      type
                      object {
                        ... on Tree {
                          entries {
                            name
                            type
                            object {
                              ... on Tree {
                                entries {
                                  name
                                  type
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        
          # Get commits from the last month to count contributors
          defaultBranchRef {
            target {
              ... on Commit {
                history(first: 100, since: $since) {
                  nodes {
                    author {
                      user {
                        login
                      }
                      email
                    }
                  }
                }
              }
            }
          }
          
          # Get recent issues for time to first response calculation
          issues(first: 50, orderBy: {field: CREATED_AT, direction: DESC}) {
            nodes {
              number
              createdAt
              author {
                login
              }
              comments(first: 10) {
                nodes {
                  createdAt
                  author {
                    login
                  }
                }
              }
            }
          }
          
          # Get issue counts for maintenance signal
          openIssues: issues(states: OPEN) {
            totalCount
          }
          
          allIssues: issues {
            totalCount
          }
          
          # Get releases from the last year for release frequency calculation
          releases(first: 100, orderBy: {field: CREATED_AT, direction: DESC}) {
            nodes {
              publishedAt
              tagName
              description
            }
          }
        }
      }
    `;
        const contentsResult = await this.executeQuery(contentsQuery, {
            owner: this.owner,
            name: this.repo,
            since: sinceDate,
        });
        if (contentsResult.error || !contentsResult.data?.repository) {
            return contentsResult;
        }
        const repository = contentsResult.data.repository;
        const entries = repository.rootContents?.entries ?? [];
        const readmeFile = entries.find((entry) => entry.type === 'blob' &&
            entry.name.toLowerCase().startsWith('readme'));
        if (!readmeFile) {
            return {
                data: {
                    repository: {
                        stargazerCount: repository.stargazerCount,
                        rootContents: repository.rootContents,
                        commits: repository.defaultBranchRef?.target?.history?.nodes ?? [],
                        issues: repository.issues?.nodes ?? [],
                        releases: repository.releases?.nodes ?? [],
                        openIssuesCount: repository.openIssues?.totalCount,
                        totalIssuesCount: repository.allIssues?.totalCount,
                    },
                },
            };
        }
        // Second query: Get README content only
        const readmeQuery = `
      query GetReadmeContent($owner: String!, $name: String!, $path: String!) {
        repository(owner: $owner, name: $name) {
          readme: object(expression: $path) {
            ... on Blob {
              text
            }
          }
        }
      }
    `;
        const readmeResult = await this.executeQuery(readmeQuery, {
            owner: this.owner,
            name: this.repo,
            path: `HEAD:${readmeFile.name}`,
        });
        if (readmeResult.error || !readmeResult.data?.repository) {
            return readmeResult;
        }
        // Extract README text
        const readmeText = readmeResult.data.repository.readme?.text;
        return {
            data: {
                repository: {
                    stargazerCount: repository.stargazerCount,
                    rootContents: repository.rootContents,
                    readmeContent: readmeText,
                    commits: repository.defaultBranchRef?.target?.history?.nodes ?? [],
                    issues: repository.issues?.nodes ?? [],
                    releases: repository.releases?.nodes ?? [],
                    openIssuesCount: repository.openIssues?.totalCount,
                    totalIssuesCount: repository.allIssues?.totalCount,
                },
            },
        };
    }
    async executeQuery(query, variables) {
        try {
            const headers = {
                'Content-Type': 'application/json',
                'User-Agent': 'cdk-construct-analyzer',
            };
            const token = process.env.GITHUB_TOKEN;
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }
            const response = await fetch(this.graphqlUrl, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    query,
                    variables,
                }),
            });
            if (!response.ok) {
                return {
                    error: `GitHub GraphQL API returned ${response.status}: ${response.statusText}`,
                };
            }
            const result = await response.json();
            if (result.errors) {
                return {
                    error: `GraphQL errors: ${result.errors.map((e) => e.message).join(', ')}`,
                };
            }
            return { data: result.data };
        }
        catch (error) {
            return {
                error: `Network error: ${error.message ?? 'Unknown error'}`,
            };
        }
    }
}
exports.GitHubRepo = GitHubRepo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0aHViLXJlcG8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGlicmFyeS9kYXRhL2dpdGh1Yi1yZXBvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQU9BLE1BQWEsVUFBVTtJQUdyQixZQUFxQixLQUFhLEVBQVcsSUFBWTtRQUFwQyxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQVcsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUZ4QyxlQUFVLEdBQUcsZ0NBQWdDLENBQUM7SUFFRixDQUFDO0lBRTlELEtBQUssQ0FBQyxRQUFRO1FBQ1osTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM5QixVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyRCxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFM0MsTUFBTSxhQUFhLEdBQUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0tBK0ZyQixDQUFDO1FBRUYsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRTtZQUM1RCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsS0FBSyxFQUFFLFNBQVM7U0FDakIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxjQUFjLENBQUMsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQztZQUM3RCxPQUFPLGNBQWMsQ0FBQztRQUN4QixDQUFDO1FBRUQsTUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFpQixDQUFDO1FBQ3pELE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FB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QU0sRUFBRSxNQUFNO2dCQUNkLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQ25CLEtBQUs7b0JBQ0wsU0FBUztpQkFDVixDQUFDO2FBQ0gsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDakIsT0FBTztvQkFDTCxLQUFLLEVBQUUsK0JBQStCLFFBQVEsQ0FBQyxNQUFNLEtBQUssUUFBUSxDQUFDLFVBQVUsRUFBRTtpQkFDaEYsQ0FBQztZQUNKLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQVMsQ0FBQztZQUU1QyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDbEIsT0FBTztvQkFDTCxLQUFLLEVBQUUsbUJBQW1CLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2lCQUNoRixDQUFDO1lBQ0osQ0FBQztZQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQy9CLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU87Z0JBQ0wsS0FBSyxFQUFFLGtCQUFrQixLQUFLLENBQUMsT0FBTyxJQUFJLGVBQWUsRUFBRTthQUM1RCxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7Q0FDRjtBQWpPRCxnQ0FpT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHaXRIdWJSZXBvc2l0b3J5IH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEdpdEh1YkFwaVJlc3BvbnNlIHtcbiAgZGF0YT86IHsgcmVwb3NpdG9yeTogR2l0SHViUmVwb3NpdG9yeSB9O1xuICBlcnJvcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEdpdEh1YlJlcG8ge1xuICBwcml2YXRlIHJlYWRvbmx5IGdyYXBocWxVcmwgPSAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9ncmFwaHFsJztcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBvd25lcjogc3RyaW5nLCByZWFkb25seSByZXBvOiBzdHJpbmcpIHsgfVxuXG4gIGFzeW5jIG1ldGFkYXRhKCk6IFByb21pc2U8R2l0SHViQXBpUmVzcG9uc2U+IHtcbiAgICBjb25zdCBvbmVZZWFyQWdvID0gbmV3IERhdGUoKTtcbiAgICBvbmVZZWFyQWdvLnNldEZ1bGxZZWFyKG9uZVllYXJBZ28uZ2V0RnVsbFllYXIoKSAtIDEpO1xuICAgIGNvbnN0IHNpbmNlRGF0ZSA9IG9uZVllYXJBZ28udG9JU09TdHJpbmcoKTtcblxuICAgIGNvbnN0IGNvbnRlbnRzUXVlcnkgPSBgXG4gICAgICBxdWVyeSBHZXRSZXBvc2l0b3J5RGF0YSgkb3duZXI6IFN0cmluZyEsICRuYW1lOiBTdHJpbmchLCAkc2luY2U6IEdpdFRpbWVzdGFtcCEpIHtcbiAgICAgICAgcmVwb3NpdG9yeShvd25lcjogJG93bmVyLCBuYW1lOiAkbmFtZSkge1xuICAgICAgICAgIHN0YXJnYXplckNvdW50XG4gICAgICAgICAgXG4gICAgICAgICAgIyBSb290IGRpcmVjdG9yeSBjb250ZW50cyB3aXRoIG5lc3RlZCBkaXJlY3RvcnkgY29udGVudHMgKDQgbGV2ZWxzIGRlZXApXG4gICAgICAgICAgcm9vdENvbnRlbnRzOiBvYmplY3QoZXhwcmVzc2lvbjogXCJIRUFEOlwiKSB7XG4gICAgICAgICAgICAuLi4gb24gVHJlZSB7XG4gICAgICAgICAgICAgIGVudHJpZXMge1xuICAgICAgICAgICAgICAgIG5hbWVcbiAgICAgICAgICAgICAgICB0eXBlXG4gICAgICAgICAgICAgICAgb2JqZWN0IHtcbiAgICAgICAgICAgICAgICAgIC4uLiBvbiBUcmVlIHtcbiAgICAgICAgICAgICAgICAgICAgZW50cmllcyB7XG4gICAgICAgICAgICAgICAgICAgICAgbmFtZVxuICAgICAgICAgICAgICAgICAgICAgIHR5cGVcbiAgICAgICAgICAgICAgICAgICAgICBvYmplY3Qge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uIG9uIFRyZWUge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyaWVzIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi4gb24gVHJlZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICMgR2V0IGNvbW1pdHMgZnJvbSB0aGUgbGFzdCBtb250aCB0byBjb3VudCBjb250cmlidXRvcnNcbiAgICAgICAgICBkZWZhdWx0QnJhbmNoUmVmIHtcbiAgICAgICAgICAgIHRhcmdldCB7XG4gICAgICAgICAgICAgIC4uLiBvbiBDb21taXQge1xuICAgICAgICAgICAgICAgIGhpc3RvcnkoZmlyc3Q6IDEwMCwgc2luY2U6ICRzaW5jZSkge1xuICAgICAgICAgICAgICAgICAgbm9kZXMge1xuICAgICAgICAgICAgICAgICAgICBhdXRob3Ige1xuICAgICAgICAgICAgICAgICAgICAgIHVzZXIge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9naW5cbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgZW1haWxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICAjIEdldCByZWNlbnQgaXNzdWVzIGZvciB0aW1lIHRvIGZpcnN0IHJlc3BvbnNlIGNhbGN1bGF0aW9uXG4gICAgICAgICAgaXNzdWVzKGZpcnN0OiA1MCwgb3JkZXJCeToge2ZpZWxkOiBDUkVBVEVEX0FULCBkaXJlY3Rpb246IERFU0N9KSB7XG4gICAgICAgICAgICBub2RlcyB7XG4gICAgICAgICAgICAgIG51bWJlclxuICAgICAgICAgICAgICBjcmVhdGVkQXRcbiAgICAgICAgICAgICAgYXV0aG9yIHtcbiAgICAgICAgICAgICAgICBsb2dpblxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbW1lbnRzKGZpcnN0OiAxMCkge1xuICAgICAgICAgICAgICAgIG5vZGVzIHtcbiAgICAgICAgICAgICAgICAgIGNyZWF0ZWRBdFxuICAgICAgICAgICAgICAgICAgYXV0aG9yIHtcbiAgICAgICAgICAgICAgICAgICAgbG9naW5cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgIyBHZXQgaXNzdWUgY291bnRzIGZvciBtYWludGVuYW5jZSBzaWduYWxcbiAgICAgICAgICBvcGVuSXNzdWVzOiBpc3N1ZXMoc3RhdGVzOiBPUEVOKSB7XG4gICAgICAgICAgICB0b3RhbENvdW50XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIGFsbElzc3VlczogaXNzdWVzIHtcbiAgICAgICAgICAgIHRvdGFsQ291bnRcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgIyBHZXQgcmVsZWFzZXMgZnJvbSB0aGUgbGFzdCB5ZWFyIGZvciByZWxlYXNlIGZyZXF1ZW5jeSBjYWxjdWxhdGlvblxuICAgICAgICAgIHJlbGVhc2VzKGZpcnN0OiAxMDAsIG9yZGVyQnk6IHtmaWVsZDogQ1JFQVRFRF9BVCwgZGlyZWN0aW9uOiBERVNDfSkge1xuICAgICAgICAgICAgbm9kZXMge1xuICAgICAgICAgICAgICBwdWJsaXNoZWRBdFxuICAgICAgICAgICAgICB0YWdOYW1lXG4gICAgICAgICAgICAgIGRlc2NyaXB0aW9uXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcblxuICAgIGNvbnN0IGNvbnRlbnRzUmVzdWx0ID0gYXdhaXQgdGhpcy5leGVjdXRlUXVlcnkoY29udGVudHNRdWVyeSwge1xuICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICBuYW1lOiB0aGlzLnJlcG8sXG4gICAgICBzaW5jZTogc2luY2VEYXRlLFxuICAgIH0pO1xuXG4gICAgaWYgKGNvbnRlbnRzUmVzdWx0LmVycm9yIHx8ICFjb250ZW50c1Jlc3VsdC5kYXRhPy5yZXBvc2l0b3J5KSB7XG4gICAgICByZXR1cm4gY29udGVudHNSZXN1bHQ7XG4gICAgfVxuXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IGNvbnRlbnRzUmVzdWx0LmRhdGEucmVwb3NpdG9yeSBhcyBhbnk7XG4gICAgY29uc3QgZW50cmllcyA9IHJlcG9zaXRvcnkucm9vdENvbnRlbnRzPy5lbnRyaWVzID8/IFtdO1xuXG4gICAgY29uc3QgcmVhZG1lRmlsZSA9IGVudHJpZXMuZmluZCgoZW50cnk6IGFueSkgPT5cbiAgICAgIGVudHJ5LnR5cGUgPT09ICdibG9iJyAmJlxuICAgICAgZW50cnkubmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ3JlYWRtZScpLFxuICAgICk7XG5cbiAgICBpZiAoIXJlYWRtZUZpbGUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICByZXBvc2l0b3J5OiB7XG4gICAgICAgICAgICBzdGFyZ2F6ZXJDb3VudDogcmVwb3NpdG9yeS5zdGFyZ2F6ZXJDb3VudCxcbiAgICAgICAgICAgIHJvb3RDb250ZW50czogcmVwb3NpdG9yeS5yb290Q29udGVudHMsXG4gICAgICAgICAgICBjb21taXRzOiByZXBvc2l0b3J5LmRlZmF1bHRCcmFuY2hSZWY/LnRhcmdldD8uaGlzdG9yeT8ubm9kZXMgPz8gW10sXG4gICAgICAgICAgICBpc3N1ZXM6IHJlcG9zaXRvcnkuaXNzdWVzPy5ub2RlcyA/PyBbXSxcbiAgICAgICAgICAgIHJlbGVhc2VzOiByZXBvc2l0b3J5LnJlbGVhc2VzPy5ub2RlcyA/PyBbXSxcbiAgICAgICAgICAgIG9wZW5Jc3N1ZXNDb3VudDogcmVwb3NpdG9yeS5vcGVuSXNzdWVzPy50b3RhbENvdW50LFxuICAgICAgICAgICAgdG90YWxJc3N1ZXNDb3VudDogcmVwb3NpdG9yeS5hbGxJc3N1ZXM/LnRvdGFsQ291bnQsXG4gICAgICAgICAgfSBhcyBHaXRIdWJSZXBvc2l0b3J5LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBTZWNvbmQgcXVlcnk6IEdldCBSRUFETUUgY29udGVudCBvbmx5XG4gICAgY29uc3QgcmVhZG1lUXVlcnkgPSBgXG4gICAgICBxdWVyeSBHZXRSZWFkbWVDb250ZW50KCRvd25lcjogU3RyaW5nISwgJG5hbWU6IFN0cmluZyEsICRwYXRoOiBTdHJpbmchKSB7XG4gICAgICAgIHJlcG9zaXRvcnkob3duZXI6ICRvd25lciwgbmFtZTogJG5hbWUpIHtcbiAgICAgICAgICByZWFkbWU6IG9iamVjdChleHByZXNzaW9uOiAkcGF0aCkge1xuICAgICAgICAgICAgLi4uIG9uIEJsb2Ige1xuICAgICAgICAgICAgICB0ZXh0XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYDtcblxuICAgIGNvbnN0IHJlYWRtZVJlc3VsdCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVF1ZXJ5KHJlYWRtZVF1ZXJ5LCB7XG4gICAgICBvd25lcjogdGhpcy5vd25lcixcbiAgICAgIG5hbWU6IHRoaXMucmVwbyxcbiAgICAgIHBhdGg6IGBIRUFEOiR7cmVhZG1lRmlsZS5uYW1lfWAsXG4gICAgfSk7XG5cbiAgICBpZiAocmVhZG1lUmVzdWx0LmVycm9yIHx8ICFyZWFkbWVSZXN1bHQuZGF0YT8ucmVwb3NpdG9yeSkge1xuICAgICAgcmV0dXJuIHJlYWRtZVJlc3VsdDtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IFJFQURNRSB0ZXh0XG4gICAgY29uc3QgcmVhZG1lVGV4dCA9IChyZWFkbWVSZXN1bHQuZGF0YS5yZXBvc2l0b3J5IGFzIGFueSkucmVhZG1lPy50ZXh0O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcmVwb3NpdG9yeToge1xuICAgICAgICAgIHN0YXJnYXplckNvdW50OiByZXBvc2l0b3J5LnN0YXJnYXplckNvdW50LFxuICAgICAgICAgIHJvb3RDb250ZW50czogcmVwb3NpdG9yeS5yb290Q29udGVudHMsXG4gICAgICAgICAgcmVhZG1lQ29udGVudDogcmVhZG1lVGV4dCxcbiAgICAgICAgICBjb21taXRzOiByZXBvc2l0b3J5LmRlZmF1bHRCcmFuY2hSZWY/LnRhcmdldD8uaGlzdG9yeT8ubm9kZXMgPz8gW10sXG4gICAgICAgICAgaXNzdWVzOiByZXBvc2l0b3J5Lmlzc3Vlcz8ubm9kZXMgPz8gW10sXG4gICAgICAgICAgcmVsZWFzZXM6IHJlcG9zaXRvcnkucmVsZWFzZXM/Lm5vZGVzID8/IFtdLFxuICAgICAgICAgIG9wZW5Jc3N1ZXNDb3VudDogcmVwb3NpdG9yeS5vcGVuSXNzdWVzPy50b3RhbENvdW50LFxuICAgICAgICAgIHRvdGFsSXNzdWVzQ291bnQ6IHJlcG9zaXRvcnkuYWxsSXNzdWVzPy50b3RhbENvdW50LFxuICAgICAgICB9IGFzIEdpdEh1YlJlcG9zaXRvcnksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGV4ZWN1dGVRdWVyeShxdWVyeTogc3RyaW5nLCB2YXJpYWJsZXM6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBQcm9taXNlPEdpdEh1YkFwaVJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdVc2VyLUFnZW50JzogJ2Nkay1jb25zdHJ1Y3QtYW5hbHl6ZXInLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgdG9rZW4gPSBwcm9jZXNzLmVudi5HSVRIVUJfVE9LRU47XG4gICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgaGVhZGVycy5BdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godGhpcy5ncmFwaHFsVXJsLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcXVlcnksXG4gICAgICAgICAgdmFyaWFibGVzLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZXJyb3I6IGBHaXRIdWIgR3JhcGhRTCBBUEkgcmV0dXJuZWQgJHtyZXNwb25zZS5zdGF0dXN9OiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIGFueTtcblxuICAgICAgaWYgKHJlc3VsdC5lcnJvcnMpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBlcnJvcjogYEdyYXBoUUwgZXJyb3JzOiAke3Jlc3VsdC5lcnJvcnMubWFwKChlOiBhbnkpID0+IGUubWVzc2FnZSkuam9pbignLCAnKX1gLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4geyBkYXRhOiByZXN1bHQuZGF0YSB9O1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGVycm9yOiBgTmV0d29yayBlcnJvcjogJHtlcnJvci5tZXNzYWdlID8/ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn0iXX0=