"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConstructAnalyzer = void 0;
const config_1 = require("./config");
const collect_1 = require("./data/collect");
class ConstructAnalyzer {
    constructor() {
        this.config = config_1.CONFIG;
    }
    async analyzePackage(packageName, weights) {
        const packageData = await (0, collect_1.collectPackageData)(packageName);
        const version = packageData.version;
        const { signalScores, pillarScores, totalScore } = await this.calculateSignalScores(packageData, weights);
        const normalizedPillarScores = this.normalizePillarScores(pillarScores, weights);
        const signalWeights = this.getSignalWeights(weights);
        return {
            packageName,
            version,
            totalScore,
            pillarScores: normalizedPillarScores,
            signalScores,
            signalWeights,
        };
    }
    async calculateSignalScores(packageData, weights) {
        var _a;
        const signalScores = {};
        const pillarScores = Object.fromEntries(Object.values(config_1.Pillar).map(pillar => [pillar, 0]));
        let totalWeightedSum = 0;
        let totalWeight = 0;
        for (const pillar of this.config.pillars) {
            for (const signal of pillar.signals) {
                const level = signal.benchmarks(packageData[signal.name]);
                const points = this.convertLevelToPoints(level, signal.name);
                const weight = weights?.[signal.name] ?? signal.defaultWeight;
                (signalScores[_a = pillar.name] ?? (signalScores[_a] = {}))[signal.name] = level ?? 1;
                pillarScores[pillar.name] = (pillarScores[pillar.name] || 0) + points * weight;
                totalWeightedSum += points * weight;
                totalWeight += weight;
            }
        }
        if (totalWeight != 100) {
            console.warn(`Warning: Signal weights sum to ${totalWeight} instead of 100. ` +
                'Weights should sum to 100 as it\'s universally understood and can be interpreted as percentages. ' +
                'Weights will be automatically normalized.');
        }
        const totalScore = totalWeight > 0 ? Math.round(totalWeightedSum / totalWeight) : 0;
        return { signalScores, pillarScores, totalScore };
    }
    convertLevelToPoints(level, signalName) {
        if (level == undefined) {
            console.warn(`Signal data not found: ${signalName}, assigning score of 0`);
            return 0;
        }
        return (level - 1) * 25;
    }
    normalizePillarScores(pillarScores, weights) {
        const normalizedScores = Object.fromEntries(Object.values(config_1.Pillar).map(pillar => [pillar, 0]));
        const pillarEntries = Object.entries(pillarScores);
        for (const [pillar, weightedSum] of pillarEntries) {
            const totalWeight = this.getTotalWeightForPillar(pillar, weights);
            const normalizedScore = totalWeight > 0 ? Math.min(100, weightedSum / totalWeight) : 0;
            normalizedScores[pillar] = Math.round(normalizedScore);
        }
        return normalizedScores;
    }
    getTotalWeightForPillar(pillarName, weights) {
        const pillar = this.config.pillars.find(p => p.name === pillarName);
        if (!pillar)
            return 0;
        return pillar.signals.reduce((sum, signal) => {
            const weight = weights?.[signal.name] ?? signal.defaultWeight;
            return sum + weight;
        }, 0);
    }
    /**
     * Extract signal weights from config in the same structure as signalScores
     * Uses custom weights when provided, otherwise falls back to default weights
     */
    getSignalWeights(weights) {
        var _a;
        const signalWeights = {};
        for (const pillar of this.config.pillars) {
            for (const signal of pillar.signals) {
                const weight = weights?.[signal.name] ?? signal.defaultWeight;
                (signalWeights[_a = pillar.name] ?? (signalWeights[_a] = {}))[signal.name] = weight;
            }
        }
        return signalWeights;
    }
}
exports.ConstructAnalyzer = ConstructAnalyzer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5hbHl6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGlicmFyeS9hbmFseXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBMEM7QUFDMUMsNENBQW9EO0FBR3BELE1BQWEsaUJBQWlCO0lBRzVCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxlQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVNLEtBQUssQ0FBQyxjQUFjLENBQUMsV0FBbUIsRUFBRSxPQUF1QjtRQUN0RSxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUEsNEJBQWtCLEVBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUQsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUVwQyxNQUFNLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUcsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBMkIsQ0FBQztRQUMzRyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFckQsT0FBTztZQUNMLFdBQVc7WUFDWCxPQUFPO1lBQ1AsVUFBVTtZQUNWLFlBQVksRUFBRSxzQkFBc0I7WUFDcEMsWUFBWTtZQUNaLGFBQWE7U0FDZCxDQUFDO0lBQ0osQ0FBQztJQUVPLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxXQUF3QixFQUFFLE9BQXVCOztRQUNuRixNQUFNLFlBQVksR0FBMkMsRUFBRSxDQUFDO1FBQ2hFLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQ3JDLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFD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QUFhLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBL0dELDhDQStHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENPTkZJRywgUGlsbGFyIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHsgY29sbGVjdFBhY2thZ2VEYXRhIH0gZnJvbSAnLi9kYXRhL2NvbGxlY3QnO1xuaW1wb3J0IHR5cGUgeyBTY29yZVJlc3VsdCwgQ29uZmlnLCBQYWNrYWdlRGF0YSwgU2lnbmFsV2VpZ2h0cywgUGlsbGFyU2NvcmVzIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBDb25zdHJ1Y3RBbmFseXplciB7XG4gIHByaXZhdGUgY29uZmlnOiBDb25maWc7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5jb25maWcgPSBDT05GSUc7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYW5hbHl6ZVBhY2thZ2UocGFja2FnZU5hbWU6IHN0cmluZywgd2VpZ2h0cz86IFNpZ25hbFdlaWdodHMpOiBQcm9taXNlPFNjb3JlUmVzdWx0PiB7XG4gICAgY29uc3QgcGFja2FnZURhdGEgPSBhd2FpdCBjb2xsZWN0UGFja2FnZURhdGEocGFja2FnZU5hbWUpO1xuICAgIGNvbnN0IHZlcnNpb24gPSBwYWNrYWdlRGF0YS52ZXJzaW9uO1xuXG4gICAgY29uc3QgeyBzaWduYWxTY29yZXMsIHBpbGxhclNjb3JlcywgdG90YWxTY29yZSB9ID0gYXdhaXQgdGhpcy5jYWxjdWxhdGVTaWduYWxTY29yZXMocGFja2FnZURhdGEsIHdlaWdodHMpO1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRQaWxsYXJTY29yZXMgPSB0aGlzLm5vcm1hbGl6ZVBpbGxhclNjb3JlcyhwaWxsYXJTY29yZXMsIHdlaWdodHMpIGFzIFJlYWRvbmx5PFBpbGxhclNjb3Jlcz47XG4gICAgY29uc3Qgc2lnbmFsV2VpZ2h0cyA9IHRoaXMuZ2V0U2lnbmFsV2VpZ2h0cyh3ZWlnaHRzKTtcblxuICAgIHJldHVybiB7XG4gICAgICBwYWNrYWdlTmFtZSxcbiAgICAgIHZlcnNpb24sXG4gICAgICB0b3RhbFNjb3JlLFxuICAgICAgcGlsbGFyU2NvcmVzOiBub3JtYWxpemVkUGlsbGFyU2NvcmVzLFxuICAgICAgc2lnbmFsU2NvcmVzLFxuICAgICAgc2lnbmFsV2VpZ2h0cyxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjYWxjdWxhdGVTaWduYWxTY29yZXMocGFja2FnZURhdGE6IFBhY2thZ2VEYXRhLCB3ZWlnaHRzPzogU2lnbmFsV2VpZ2h0cykge1xuICAgIGNvbnN0IHNpZ25hbFNjb3JlczogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgbnVtYmVyPj4gPSB7fTtcbiAgICBjb25zdCBwaWxsYXJTY29yZXMgPSBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgICBPYmplY3QudmFsdWVzKFBpbGxhcikubWFwKHBpbGxhciA9PiBbcGlsbGFyLCAwXSksXG4gICAgKSBhcyBQaWxsYXJTY29yZXM7XG5cbiAgICBsZXQgdG90YWxXZWlnaHRlZFN1bSA9IDA7XG4gICAgbGV0IHRvdGFsV2VpZ2h0ID0gMDtcblxuICAgIGZvciAoY29uc3QgcGlsbGFyIG9mIHRoaXMuY29uZmlnLnBpbGxhcnMpIHtcbiAgICAgIGZvciAoY29uc3Qgc2lnbmFsIG9mIHBpbGxhci5zaWduYWxzKSB7XG4gICAgICAgIGNvbnN0IGxldmVsID0gc2lnbmFsLmJlbmNobWFya3MocGFja2FnZURhdGFbc2lnbmFsLm5hbWVdKTtcbiAgICAgICAgY29uc3QgcG9pbnRzID0gdGhpcy5jb252ZXJ0TGV2ZWxUb1BvaW50cyhsZXZlbCwgc2lnbmFsLm5hbWUpO1xuXG4gICAgICAgIGNvbnN0IHdlaWdodCA9IHdlaWdodHM/LltzaWduYWwubmFtZV0gPz8gc2lnbmFsLmRlZmF1bHRXZWlnaHQ7XG5cbiAgICAgICAgKHNpZ25hbFNjb3Jlc1twaWxsYXIubmFtZV0gPz89IHt9KVtzaWduYWwubmFtZV0gPSBsZXZlbCA/PyAxO1xuICAgICAgICBwaWxsYXJTY29yZXNbcGlsbGFyLm5hbWUgYXMgUGlsbGFyXSA9IChwaWxsYXJTY29yZXNbcGlsbGFyLm5hbWUgYXMgUGlsbGFyXSB8fCAwKSArIHBvaW50cyAqIHdlaWdodDtcblxuICAgICAgICB0b3RhbFdlaWdodGVkU3VtICs9IHBvaW50cyAqIHdlaWdodDtcbiAgICAgICAgdG90YWxXZWlnaHQgKz0gd2VpZ2h0O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0b3RhbFdlaWdodCAhPSAxMDApIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYFdhcm5pbmc6IFNpZ25hbCB3ZWlnaHRzIHN1bSB0byAke3RvdGFsV2VpZ2h0fSBpbnN0ZWFkIG9mIDEwMC4gYCArXG4gICAgICAgICdXZWlnaHRzIHNob3VsZCBzdW0gdG8gMTAwIGFzIGl0XFwncyB1bml2ZXJzYWxseSB1bmRlcnN0b29kIGFuZCBjYW4gYmUgaW50ZXJwcmV0ZWQgYXMgcGVyY2VudGFnZXMuICcgK1xuICAgICAgICAnV2VpZ2h0cyB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgbm9ybWFsaXplZC4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB0b3RhbFNjb3JlID0gdG90YWxXZWlnaHQgPiAwID8gTWF0aC5yb3VuZCh0b3RhbFdlaWdodGVkU3VtIC8gdG90YWxXZWlnaHQpIDogMDtcblxuICAgIHJldHVybiB7IHNpZ25hbFNjb3JlcywgcGlsbGFyU2NvcmVzLCB0b3RhbFNjb3JlIH07XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRMZXZlbFRvUG9pbnRzKGxldmVsOiBudW1iZXIgfCB1bmRlZmluZWQsIHNpZ25hbE5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgaWYgKGxldmVsID09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKGBTaWduYWwgZGF0YSBub3QgZm91bmQ6ICR7c2lnbmFsTmFtZX0sIGFzc2lnbmluZyBzY29yZSBvZiAwYCk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIChsZXZlbCAtIDEpICogMjU7XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVBpbGxhclNjb3JlcyhwaWxsYXJTY29yZXM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4sIHdlaWdodHM/OiBTaWduYWxXZWlnaHRzKTogUGlsbGFyU2NvcmVzIHtcbiAgICBjb25zdCBub3JtYWxpemVkU2NvcmVzID0gT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgT2JqZWN0LnZhbHVlcyhQaWxsYXIpLm1hcChwaWxsYXIgPT4gW3BpbGxhciwgMF0pLFxuICAgICkgYXMgUGlsbGFyU2NvcmVzO1xuXG4gICAgY29uc3QgcGlsbGFyRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHBpbGxhclNjb3Jlcyk7XG4gICAgZm9yIChjb25zdCBbcGlsbGFyLCB3ZWlnaHRlZFN1bV0gb2YgcGlsbGFyRW50cmllcykge1xuICAgICAgY29uc3QgdG90YWxXZWlnaHQgPSB0aGlzLmdldFRvdGFsV2VpZ2h0Rm9yUGlsbGFyKHBpbGxhciwgd2VpZ2h0cyk7XG4gICAgICBjb25zdCBub3JtYWxpemVkU2NvcmUgPSB0b3RhbFdlaWdodCA+IDAgPyBNYXRoLm1pbigxMDAsIHdlaWdodGVkU3VtIC8gdG90YWxXZWlnaHQpIDogMDtcbiAgICAgIG5vcm1hbGl6ZWRTY29yZXNbcGlsbGFyIGFzIGtleW9mIFBpbGxhclNjb3Jlc10gPSBNYXRoLnJvdW5kKG5vcm1hbGl6ZWRTY29yZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5vcm1hbGl6ZWRTY29yZXM7XG4gIH1cblxuICBwcml2YXRlIGdldFRvdGFsV2VpZ2h0Rm9yUGlsbGFyKHBpbGxhck5hbWU6IHN0cmluZywgd2VpZ2h0cz86IFNpZ25hbFdlaWdodHMpOiBudW1iZXIge1xuICAgIGNvbnN0IHBpbGxhciA9IHRoaXMuY29uZmlnLnBpbGxhcnMuZmluZChwID0+IHAubmFtZSA9PT0gcGlsbGFyTmFtZSk7XG4gICAgaWYgKCFwaWxsYXIpIHJldHVybiAwO1xuXG4gICAgcmV0dXJuIHBpbGxhci5zaWduYWxzLnJlZHVjZSgoc3VtLCBzaWduYWwpID0+IHtcbiAgICAgIGNvbnN0IHdlaWdodCA9IHdlaWdodHM/LltzaWduYWwubmFtZV0gPz8gc2lnbmFsLmRlZmF1bHRXZWlnaHQ7XG4gICAgICByZXR1cm4gc3VtICsgd2VpZ2h0O1xuICAgIH0sIDApO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3Qgc2lnbmFsIHdlaWdodHMgZnJvbSBjb25maWcgaW4gdGhlIHNhbWUgc3RydWN0dXJlIGFzIHNpZ25hbFNjb3Jlc1xuICAgKiBVc2VzIGN1c3RvbSB3ZWlnaHRzIHdoZW4gcHJvdmlkZWQsIG90aGVyd2lzZSBmYWxscyBiYWNrIHRvIGRlZmF1bHQgd2VpZ2h0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRTaWduYWxXZWlnaHRzKHdlaWdodHM/OiBTaWduYWxXZWlnaHRzKTogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgbnVtYmVyPj4ge1xuICAgIGNvbnN0IHNpZ25hbFdlaWdodHM6IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIG51bWJlcj4+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHBpbGxhciBvZiB0aGlzLmNvbmZpZy5waWxsYXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IHNpZ25hbCBvZiBwaWxsYXIuc2lnbmFscykge1xuICAgICAgICBjb25zdCB3ZWlnaHQgPSB3ZWlnaHRzPy5bc2lnbmFsLm5hbWVdID8/IHNpZ25hbC5kZWZhdWx0V2VpZ2h0O1xuICAgICAgICAoc2lnbmFsV2VpZ2h0c1twaWxsYXIubmFtZV0gPz89IHt9KVtzaWduYWwubmFtZV0gPSB3ZWlnaHQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNpZ25hbFdlaWdodHM7XG4gIH1cbn0iXX0=